# План реализации оставшихся требований ТЗ

План по 9 пунктам из «Соответствие ТЗ»: этапы, приоритеты и задачи.

---

## Обозначения

- **Фаза 1** — можно реализовать в текущем стеке (FastAPI + SQLite + React) без внешних сервисов.
- **Фаза 2** — требуется интеграция (API ключи, сертификаты, внешние системы).
- **Фаза 3** — инфраструктура и эксплуатация.

---

## 1. Карточка клиента с историей

| Задача | Фаза | Статус |
|--------|------|--------|
| Backend: связь Document/Deal с client_id, модель Communication (канал, дата, текст, направление) | 1 | Запланировано |
| Backend: API GET /api/clients/{id}/card — профиль + сделки + документы + коммуникации | 1 | Запланировано |
| Frontend: страница или модалка «Карточка клиента» с вкладками: Профиль, Сделки, Документы, Коммуникации | 1 | Запланировано |
| Заполнение client_id при создании сделки/документа из карточки | 1 | Запланировано |

---

## 2. Проверка ИНН/ОГРН через ФНС

| Задача | Фаза | Статус |
|--------|------|--------|
| Backend: эндпоинт POST /api/fns/check (body: inn или ogrn) — заглушка или вызов ФНС при наличии ключа | 1 (заглушка) / 2 (реальный API) | Заглушка: запланировано |
| Frontend: кнопка «Проверить ИНН/ОГРН» в форме клиента, вызов API, отображение результата | 1 | Запланировано |
| Реальная интеграция с ФНС (регистрация, API) | 2 | Вне текущей реализации |

---

## 3. Ролевая модель

| Задача | Фаза | Статус |
|--------|------|--------|
| Backend: модели User (email, role, password_hash), Role или enum (admin, manager, appraiser, expert, client) | 1 | Запланировано |
| Backend: регистрация/логин (JWT или сессии), зависимость get_current_user, проверка роли | 1 | Запланировано |
| Backend: разграничение доступа к эндпоинтам по ролям | 1 | Запланировано |
| Frontend: хранение роли пользователя (контекст/state), отображение меню в зависимости от роли | 1 | Запланировано |

---

## 4. OCR и извлечение данных

| Задача | Фаза | Статус |
|--------|------|--------|
| Backend: установка pytesseract, эндпоинт POST /api/documents/{id}/ocr или /api/ocr (file) → текст + структура (заглушка полей) | 1 | Запланировано |
| Frontend: кнопка «Распознать» у документа, отправка файла, отображение текста/полей | 1 | Запланировано |
| Дообучение модели, извлечение реквизитов (паспорт, ЕГРН, суммы) — ИИ/шаблоны | 2 | Вне текущей реализации |

---

## 5. Интеграции (ФНС, ГАС, Росреестр, ОФД, ЭДО, 1С, банки, мессенджеры)

| Задача | Фаза | Статус |
|--------|------|--------|
| Backend: таблица или конфиг интеграций (ключ, включено/выключено), эндпоинты-заглушки для каждого канала | 1 | Запланировано |
| Frontend: страница «Настройки интеграций» (включение, ввод ключей — без реальной отправки) | 1 | Запланировано |
| Реальные API: ГАС «Правосудие», Росреестр, ОФД, ЭДО, 1С, банки, Telegram/MAX/BIP и т.д. | 2 | Отдельный этап по каждой интеграции |

---

## 6. Генерация документов

| Задача | Фаза | Статус |
|--------|------|--------|
| Backend: шаблоны (например .docx) или разметка; эндпоинт POST /api/documents/generate (template_key, deal_id) — подстановка данных из CRM/сделки, возврат файла | 1 | Запланировано |
| Подстановка актуального законодательства (дата, версия) — справочник или заглушка | 1 | Запланировано |
| Frontend: в «Шаблонах» кнопка «Сформировать документ» уже есть; привязать к новому API | 1 | Запланировано |

---

## 7. Архив: шифрование, сроки, экспорт

| Задача | Фаза | Статус |
|--------|------|--------|
| Backend: поле retention_years у Document (75/10/5/3 по типу), расчёт «хранить до» | 1 | Запланировано |
| Backend: эндпоинт экспорта архива в PDF или XML (список дел/документов с метаданными) для госархива | 1 | Запланировано |
| Шифрование хранилища (AES-256, LUKS) | 2 | Инфраструктура |
| Соответствие ФЗ-125, Приказ №558 (настройка сроков по типам) | 1 | Запланировано в настройках |

---

## 8. Подписи (КЭП/УКЭП, КриптоПро)

| Задача | Фаза | Статус |
|--------|------|--------|
| Backend: эндпоинт-заглушка «запрос подписи» (document_id, callback_url или статус) | 1 | Запланировано |
| Frontend: страница «Подписи» — список документов на подпись, кнопка «Подписать» (вызов заглушки) | 1 | Запланировано |
| Реальная интеграция КриптоПро (плагин, сервер подписей) | 2 | Отдельный этап |

---

## 9. Инфраструктура

| Задача | Фаза | Статус |
|--------|------|--------|
| PostgreSQL: конфиг в .env, замена engine в database.py, миграции (Alembic) | 2 | Запланировано (опционально) |
| Redis: кэш сессий/результатов OCR | 2 | После PostgreSQL |
| Celery + RabbitMQ: очередь на OCR и генерацию документов | 2 | После Redis |
| 2FA: TOTP (pyotp), эндпоинты включения/проверки кода | 2 | После авторизации |
| Резервное копирование (скрипт + облако) | 3 | Деплой |
| Docker Compose: backend, frontend (build), PostgreSQL, Redis (опционально) | 1 | Запланировано |

---

## Порядок реализации (итерации)

1. **Итерация 1 (текущая)**  
   - План (этот документ).  
   - Карточка клиента: модели Communication, поля client_id у Document/Deal; API карточки; фронт — вкладки.  
   - Роли: модели User/Role, эндпоинты auth и get_current_user, ограничение по ролям; фронт — отображение меню по роли.  
   - ФНС: заглушка /api/fns/check, вызов с формы клиента.  
   - OCR: эндпоинт /api/documents/{id}/ocr (pytesseract), кнопка в Документах.  
   - Генерация: эндпоинт /api/documents/generate, подстановка из сделки/клиента, скачивание.  
   - Архив: retention_years, экспорт PDF/XML.  
   - Подписи и интеграции: заглушки API + конфиг.  
   - Docker Compose (backend + PostgreSQL + при необходимости Redis).

2. **Итерация 2**  
   - Реальные интеграции (по одной: ФНС, затем ОФД, ЭДО и т.д.).  
   - Переход на PostgreSQL, миграции.  
   - 2FA, шифрование архива.

3. **Итерация 3**  
   - Очереди (Celery), дообучение OCR, полное соответствие НФТ ТЗ.

---

## Сделано в первой итерации

- **План** (этот документ) по 9 пунктам.
- **Карточка клиента**: модель Communication, API GET `/api/clients/{id}/card`, фронт — страница с вкладками Профиль / Сделки / Документы / Коммуникации; кнопка «Карточка» в таблице клиентов.
- **Проверка ИНН/ОГРН**: эндпоинт POST `/api/fns/check`, кнопка «Проверить» в форме добавления клиента.
- **Роли**: модели User, IntegrationConfig; API auth (login, me), сид пользователей admin/admin, manager/manager (полноценное меню по ролям на фронте — опционально).
- **OCR**: GET `/api/ocr/document/{id}`, кнопка «Распознать» в разделе Документы (требуется pytesseract и Tesseract-OCR в окружении).
- **Генерация документов**: POST `/api/generate/document` (template_key, deal_id, client_id), шаблоны — подстановка из CRM; в Шаблонах кнопка «Сформировать» вызывает API.
- **Архив**: сроки хранения по типам (retention_years), экспорт GET `/api/archive/export/xml` и `/api/archive/export/csv`; кнопки «Экспорт XML» и «Экспорт CSV» в разделе Архив документов.
- **Подписи**: POST `/api/signatures/request` (document_id); на странице Подписи — кнопка «Подписать документ» с вводом ID.
- **Интеграции**: API GET/PATCH `/api/integrations` (ключи fns, gas, ofd, edo, telegram и др.); конфиг в БД.
- **Docker**: Dockerfile для backend, docker-compose.yml (backend + закомментированный PostgreSQL).

*Документ обновляется по мере выполнения задач.*
